 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Working</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: rgb(94, 80, 236);

    .search-results-container {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 400px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background-color: rgb(74, 57, 242 );
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
	
	#search-info-container {
	  display: flex;
	  flex-direction: column;
	  gap: 10px;
	}

	.search-info-item {
	  margin-bottom: 20px;
	  display: flex;
	  align-items: center;
	  font-size: 48px;
	  font-weight: bold;
	  color: rgb(30, 110, 233);
	}

	.search-info-item label {
	  font-weight: bold;
	  color: black
	}
	table {
	    border-collapse: collapse;
	    width: 100%;
	  }
	
	  th, td {
	    padding: 8px;
	    text-align: left;
	    height: 48px; /* Set the desired height for the rows */
	  }
	
	  th {
	    background-color: #f2f2f2;
	  }
	    h3 {
	    margin: 0; /* Remove the default margin for the h3 elements */
	  }
    .seatCounter {
	  font-size: 48px;
	  font-weight: bold;
	  color: rgb(30, 110, 233);
	}
  </style>
</head>
<body>
  <div class="search-results-container">
	<div id="search-info-container">
	  <div class="search-info-item">
	  <h3 id="route">ROUTE</h3>
		  <br>
	  </div>
	</div>
	<table>
	  <tr>
	    <th>Booked</th>
	    <td><h3 class="seatCounter" id="bookedSeats"></h3></td>
	  </tr>
	  <tr>
	    <th>Available for Walk-in</th>
	    <td><h3 class="seatCounter" id="availableSeats"></h3></td></td>
	  </tr>
	</table>
  </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username');
    const busID = urlParams.get('busID');
    const prouteId = urlParams.get('id');
	const routeElement = document.getElementById('route');
	const date = urlParams.get('date');
	const time = urlParams.get('time');

	// Display pick up and dropoff 
	routeElement.textContent = prouteId || 'N/A';

</script>	
<script type="module">
	let intervalId;

    // Check if the browser supports the Geolocation API
	function upload_loc(){
		let matchedRowIndex = -1;
		if (navigator.geolocation) {
		  navigator.geolocation.getCurrentPosition(
			function(position) {
			  // Get the latitude and longitude
			  var currentX = position.coords.latitude;
			  var currentY = position.coords.longitude;
			const scriptURLdel = 'https://script.google.com/macros/s/AKfycbz46ZxZMpPJHDaqI_Eob5iJEiZzx4SWge0YjwG-rpOvLzFAULIrX-S9ZPW3779pftQ/exec';  // delete
			const scriptURL = 'https://script.google.com/macros/s/AKfycbyjTK6QD2y6UC7GvW8mSaGtic7GMc0fCbKT_TftTkxggcUe-r8-x1TJXndxz__RTV_t/exec';  // append
			const scriptURLmod = 'https://script.google.com/macros/s/AKfycbwDAdJMAXMjFWpd9oEHMIC31YnmSEX5a-9hb1XaKqUaT9xbOx74iwlL__89tBl6SIuR/exec';  // modify
			// Get the current date and time
			const currentDateTime = new Date().toLocaleString("en-US", {
				timeZone: "Asia/Shanghai",
				year: "numeric",
				month: "2-digit",
				day: "2-digit",
				hour: "2-digit",
				minute: "2-digit",
				second: "2-digit"
			  });
			const dateF = new Date(date);
			const formattedDate = `${dateF.getFullYear()}/${(dateF.getMonth() + 1).toString().padStart(2, '0')}/${dateF.getDate().toString().padStart(2, '0')}`;
			const formData = new FormData();
			formData.append('username', username);
			formData.append('busID', busID);
			formData.append('Route',prouteId);	
			formData.append('X',currentX);
			formData.append('Y',currentY);
			formData.append('last_update',currentDateTime);	
			formData.append('Date',formattedDate);	
			formData.append('Time',time);	
			
			console.log('Date: ',dateF);

			// ----- Check if have existing record
				
			const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT51YqqiM3MQNbqvF2h86hucxl0kU-wrzctUqTJkDJirHZqVQM3dFeiNlMQkLYxSfMyha3tWbN37uvF/pub?output=csv';
			console.log("lookup check")
			fetch(sheetUrl)
			  .then(response => response.text())
			  .then(data => {
			    console.log("lookup responsed")
			    // Parse the CSV data
			    const rows = data.trim().split('\n');
			    const headers = rows[0].split(',');
			    const dataRows = rows.slice(1);
			    // Find the row index that matches the current busID
			    matchedRowIndex = dataRows.findIndex(row => {
			      const values = row.split(',');
			      return values[headers.indexOf('busID')] === busID;
			    });
			  
				  
			    console.log("Row index ",matchedRowIndex)
			    if (matchedRowIndex !== -1) {

				    // ----- Found Existing Record ------
				    
				    let NEWmatchingRowIndex = matchedRowIndex + 2; // +1 to match with the real row number
				    console.log("matched row index ",NEWmatchingRowIndex)
				    formData.append('rowIndex', NEWmatchingRowIndex)

				    
			    	    // delete the old record
				    // not used
				    
				    
					function toDelete(){
					    
					      fetch(scriptURLdel, {
						  method: 'POST',
						  body: formData
						})
						.then(response => {
						  if (response.ok) {
						    console.log('Data posted successfully!');
						  } else {
						    console.error('Error posting data:', response.status);
						  }
						})
						.catch(error => {
						  console.error('Error:', error);
						});
					} // end of function toDelete

				// ----------------------------------------------------------
				    
				// to modify
				console.log("Going to modify row ",NEWmatchingRowIndex)
				fetch(scriptURLmod, {
				  method: 'POST',
				  body: formData
				})
				.then(response => {
				  if (response.ok) {
				    console.log('Data updated');
				  } else {
				    response.json().then(data => {
				      console.error('Error updating data:', data.error);
				    });
				  }
				})
				.catch(error => {
				  console.error('Error:', error);
				});
				    
				    
			    	} else {
				    
			    	
				// --------------------------------------------	
				// Append new record	
			
				function appendLastRow(){	
				try {
					console.log('Now submit to script');
				// Submit the form and wait for the fetch request to complete
				 fetch(scriptURL, { method: 'POST', body: formData })
					.then(response => {
						console.log('SUCCESS');
					})
					.catch(error => {
						console.log('ERROR');
					});
				// Redirect to next page
				//window.location.href = `boarding.html?${queryParams.toString()}`;
					
				} catch (error) {
					console.error('Error submitting form:', error);
					// Handle the error, e.g., display an error message to the user
				}	
				} // end of function appendLastRow
				appendLastRow();
			    } 
				// -----------------------------------------

				})
			  .catch(error => {
			    console.error('Error:', error);
			  });
			  
			  }) // end of function position

	  } else {
	    console.error('navigator.geolocation Error:', error);
	  }
	} // end of upload_loc function
	
	upload_loc();
	// Start the interval immediately when the page loads
	window.addEventListener('load', function() {
	  intervalId = setInterval(upload_loc, 60000); // 60000 milliseconds = 1 minute
	});



	// -----------------------------------------------------------------------------
	// Seat counters
	import { getRoutes } from './routes.js';
	async function displayFrequencyDetails() {
	      const routes = await getRoutes();
	
	      // Get the pickup and dropoff locations from the HTML
	      const bookedSeatsElement = document.getElementById('bookedSeats');
	      const availableSeatsElement = document.getElementById('availableSeats');
	
	      const timeff = document.getElementById('timef');
	      const stopff = document.getElementById('stopf');
	      const idff = document.getElementById('idf');
	      
	      const viewDetailsButton = document.getElementById('view-details-btn');
	      const timeSelector = document.getElementById('time-selector');
	      const midsStopsSelector = document.getElementById('midstops-selector');
	
	      let foundMatch = false;
	      let matchedRouteId;
	      let matchedQuota = 0;
	      let bookedPaxCount = 0;
	      routes.forEach(route => {
	        if (route.id === prouteId) {
	          foundMatch = true;
	          matchedRouteId = route.id;
		  matchedQuota = route.Quota;
		  console.log("Quota: ",matchedQuota)
	        }
	      });

		// get count from bookings
		const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxjHHSDdcYUEZMbCzUF_yov6p3Ur1nEdkGbMtaNrco6O8dQG5WLtM7YxloG8rbsZH--9J75SJWyrzR/pub?output=csv';
		console.log("bookings lookup check")
		fetch(sheetUrl)
		  .then(response => response.text())
		  .then(data => {
		    console.log("lookup responsed")
		    // Parse the CSV data
		    const rows = data.trim().split('\n');
		    const headers = rows[0].split(',');
		    const dataRows = rows.slice(1);
		    for (let i = 0; i < dataRows.length; i++) {
		    	const matchedRowValues = dataRows[i].split(',').map(data => data.replace('\r', '').replace('"', ''));  
		    	const paxdate = matchedRowValues[headers.indexOf('date')];
		    	const paxtime = matchedRowValues[headers.indexOf('time')];
		    	const paxcount = parseFloat(matchedRowValues[headers.indexOf('passengers')]);
		    	  
			if (route === prouteId && date === paxdate && time === paxtime) {
			      console.log("pax found: ",paxname)
			      bookedPaxCount = bookedPaxCount + paxcount
				const paxname = matchedRowValues[headers.indexOf('username')];
			    	const paxphone = matchedRowValues[headers.indexOf('phone')];
			    	const paxOnBoardStop = matchedRowValues[headers.indexOf('midstop')];
				// insert to pax list

				
			} else {
			   console.log("No pax found")
			}
		  })
		bookedSeatsElement.textContent = bookedPaxCount	  
		availableSeatsElement.textContent = matchedQuota - bookedPaxCount
		
	//document.getElementById('bookedSeats').textContent = '10';
	//document.getElementById('availableSeats').textContent = '20';
	
	}
	displayFrequencyDetails();
	
  </script>

</body>
</html>
